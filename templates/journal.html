{% extends "base.html" %}

{% block title %}Journal{% endblock %}

{% block content %}

<h2>Trade Journal</h2>

<div class="table-wrapper">
  <table id="tradeTable">
    <thead>
      <tr>
        <th>
          <span class="sortable" onclick="sortTable('symbol')">Symbol</span><br>
          <input type="text" onkeyup="filterTable()" data-col="symbol">
        </th>

        <th>
          <span class="sortable" onclick="sortTable('side')">Side</span><br>
          <input type="text" onkeyup="filterTable()" data-col="side">
        </th>

        <th>
          <span class="sortable" onclick="sortTable('qty')">Qty</span><br>
          <input type="text" onkeyup="filterTable()" data-col="qty">
        </th>

        <th>
          <span class="sortable" onclick="sortTable('pnl')">PnL</span><br>
          <input type="text" onkeyup="filterTable()" data-col="pnl">
        </th>

        <th>
          <span class="sortable" onclick="sortTable('boughtTimestamp')">Bought</span><br>
          <input type="text" onkeyup="filterTable()" data-col="boughtTimestamp">
        </th>

        <th>
          <span class="sortable" onclick="sortTable('soldTimestamp')">Sold</span><br>
          <input type="text" onkeyup="filterTable()" data-col="soldTimestamp">
        </th>
      </tr>
    </thead>

    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
let trades = [];
let sortState = { column: null, asc: true };

// ---------------- LOAD DATA ----------------
fetch("/api/trades")
  .then(res => res.json())
  .then(data => {
    trades = data;
    renderTable(trades);
  });

// ---------------- RENDER ----------------
function renderTable(data) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.symbol}</td>
      <td>${row.side}</td>
      <td>${row.qty}</td>
      <td>${row.pnl}</td>
      <td>${row.boughtTimestamp}</td>
      <td>${row.soldTimestamp}</td>
    `;

    tbody.appendChild(tr);
  });
}

// ---------------- SORT ----------------
function sortTable(column) {
  if (sortState.column === column) {
    sortState.asc = !sortState.asc;
  } else {
    sortState.column = column;
    sortState.asc = true;
  }

  const sorted = [...trades].sort((a, b) => {
    if (a[column] < b[column]) return sortState.asc ? -1 : 1;
    if (a[column] > b[column]) return sortState.asc ? 1 : -1;
    return 0;
  });

  renderTable(sorted);
}

// ---------------- FILTER ----------------
function filterTable() {
  const inputs = document.querySelectorAll("thead input");
  let filtered = [...trades];

  inputs.forEach(input => {
    const col = input.dataset.col;
    const val = input.value.toLowerCase();

    if (val) {
      filtered = filtered.filter(row =>
        String(row[col]).toLowerCase().includes(val)
      );
    }
  });

  renderTable(filtered);
}
</script>

{% endblock %}
