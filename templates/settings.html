{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}

<h2>Settings</h2>

<div class="settings-container">

  <!-- PROFILE -->
  <div class="settings-block">
    <h3>Profile</h3>
    <p class="muted">Coming soon</p>
  </div>

  <!-- TRADING ACCOUNTS -->
  <div class="settings-block">
    <h3>Trading Accounts</h3>

    <table class="settings-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Broker</th>
          <th>Account #</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="accountsBody"></tbody>
    </table>

    <!-- ADD ACCOUNT -->
    <div class="account-add-row" onclick="addAccountRow()">
    + Add trading account
    </div>

  </div>

  <!-- JOURNAL -->
  <div class="settings-block">
    <h3>Journal</h3>
    <p class="muted">Coming soon</p>
  </div>

</div>

<script>
/* ================= LOAD ================= */
function loadAccounts() {
  fetch("/api/accounts")
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("accountsBody");
      tbody.innerHTML = "";

      data.forEach(acc => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <input value="${acc.name || ""}"
                   onchange="updateAccount('${acc.id}','name',this.value)">
          </td>
          <td>
            <input value="${acc.broker || ""}"
                   onchange="updateAccount('${acc.id}','broker',this.value)">
          </td>
          <td>
            <input value="${acc.account_number || ""}"
                   onchange="updateAccount('${acc.id}','account_number',this.value)">
          </td>
          <td>
            <button class="danger-btn"
                    onclick="deleteAccount('${acc.id}')">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    });
}

loadAccounts();

/* ================= ACCOUNT MANAGEMENT ================= */

<script>
function addAccountRow() {
  const tbody = document.getElementById("accountsBody");

  const tr = document.createElement("tr");
  tr.classList.add("new-account-row");

  tr.innerHTML = `
    <td><input placeholder="Account name"></td>
    <td><input placeholder="Broker"></td>
    <td><input placeholder="Account #"></td>
    <td></td>
  `;

  tbody.appendChild(tr);

  const inputs = [...tr.querySelectorAll("input")];
  const [nameInput, brokerInput, numberInput] = inputs;

  nameInput.focus();

  let saved = false;

  function cleanupIfEmpty() {
    if (!nameInput.value.trim()) {
      tr.remove();
    }
  }

  function saveAccount() {
    if (saved) return;

    const payload = {
      name: nameInput.value.trim(),
      broker: brokerInput.value.trim(),
      account_number: numberInput.value.trim()
    };

    if (!payload.name) {
      cleanupIfEmpty();
      return;
    }

    saved = true;

    // Optimistic UI: mark as saving
    tr.style.opacity = "0.6";

    fetch("/api/accounts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(() => {
      tr.style.opacity = "1";
      tr.classList.remove("new-account-row");
    })
    .catch(() => {
      tr.remove();
      alert("Failed to save account");
    });
  }

  inputs.forEach(input => {
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveAccount();
      }
      if (e.key === "Escape") {
        e.preventDefault();
        cleanupIfEmpty();
      }
    });

    input.addEventListener("blur", saveAccount);
  });
}

function addAccount() {
  fetch("/api/accounts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: "",
      broker: "",
      account_number: ""
    })
  }).then(loadAccounts);
}

function updateAccount(id, field, value) {
  fetch(`/api/accounts/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ [field]: value })
  });
}

function deleteAccount(id) {
  if (!confirm("Delete this account?")) return;
  fetch(`/api/accounts/${id}`, { method: "DELETE" })
    .then(loadAccounts);
}
</script>

{% endblock %}
