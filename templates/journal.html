{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<h2>Trade Journal</h2>

<!-- ================= CONTROLS ================= -->
<div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <button onclick="applyDateFilter()">Apply Dates</button>
  <button onclick="resetFilters()">Reset filters</button>

  <div style="width:20px;"></div>

  <button onclick="deleteSelected()" style="background:#c0392b;color:white;">
    Delete selected
  </button>
</div>

<div style="display:flex; gap:20px; align-items:flex-start;">
  <div style="flex:2;">
    <table id="tradeTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="flex:1; display:flex; flex-direction:column; gap:30px;">
    <div style="height:220px;"><canvas id="pnlChart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let originalData = [];
let charts = {};
let openRow = null;
let STRATEGIES = [];
let SETUPS = [];

/* ---------------- COLUMNS ---------------- */
const COLUMN_ORDER = [
  "select","symbol","entryTimestamp","exitTimestamp",
  "duration","side","qty","entryPrice","exitPrice","pnl"
];

const COLUMN_NAMES = {
  select:"",
  symbol:"Symbol",
  entryTimestamp:"Entry",
  exitTimestamp:"Exit",
  duration:"Duration",
  side:"Side",
  qty:"Qty",
  entryPrice:"Entry",
  exitPrice:"Exit",
  pnl:"PnL"
};

/* ---------------- FORMAT ---------------- */
const pad = n => String(n).padStart(2,"0");
const formatDate = d => `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const formatPnL = v => {
  const n = Number(v)||0;
  const f = Math.abs(n).toLocaleString("en-US",{minimumFractionDigits:2});
  return n < 0 ? `($${f})` : `$${f}`;
};

/* ---------------- FETCH DATA ---------------- */
Promise.all([
  fetch("/api/strategies").then(r=>r.json()),
  fetch("/api/setups").then(r=>r.json()),
  fetch("/api/trades").then(r=>r.json())
]).then(([strategies, setups, trades])=>{
  STRATEGIES = strategies;
  SETUPS = setups;

  originalData = trades.map(t => ({
    ...t,
    entryTimestamp: new Date(t.entryTimestamp),
    exitTimestamp: new Date(t.exitTimestamp)
  }));

  buildHeaders();
  applyFiltersAndRender();
});

/* ---------------- HEADERS ---------------- */
function buildHeaders(){
  const tr = document.getElementById("headerRow");
  tr.innerHTML = "";
  COLUMN_ORDER.forEach(col => {
    const th = document.createElement("th");
    if(col === "select"){
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.onclick = e => {
        document.querySelectorAll(".row-select").forEach(x=>x.checked=e.target.checked);
      };
      th.appendChild(cb);
    } else {
      th.textContent = COLUMN_NAMES[col];
      const input = document.createElement("input");
      input.placeholder = "Filter";
      input.dataset.col = col;
      input.onkeyup = applyFiltersAndRender;
      th.append(document.createElement("br"), input);
    }
    tr.appendChild(th);
  });
}

/* ---------------- RENDER ROWS ---------------- */
function buildRows(data){
  const tbody = document.querySelector("#tradeTable tbody");
  tbody.innerHTML = "";

  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.className = "trade-row";
    tr.onclick = ()=>toggleTradeDetails(tr, row);

    COLUMN_ORDER.forEach(col=>{
      const td = document.createElement("td");

      if(col === "select"){
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "row-select";
        cb.dataset.id = row.id;
        cb.addEventListener("click", e => e.stopPropagation());
        td.appendChild(cb);
      }
      else if(col === "pnl"){
        const v = Number(row[col])||0;
        td.textContent = formatPnL(v);
        td.className = v >= 0 ? "pnl-positive" : "pnl-negative";
      }
      else if(col.includes("Timestamp")){
        td.textContent = formatDate(row[col]);
      }
      else{
        td.textContent = row[col]??"";
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ---------------- STRATEGY TAG ---------------- */
function renderStrategyTag(strategyId){
  if(!strategyId) return `<span class="strategy-tag muted">No strategy</span>`;
  const s = STRATEGIES.find(x=>x.id===strategyId);
  if(!s) return "";
  return `<span class="strategy-tag" style="background:${s.color};">${s.strategy_name}</span>`;
}

/* ---------------- SETUP TAGS ---------------- */
function renderSetupTags(assignedSetups){
  if(!assignedSetups || !assignedSetups.length) return '<span class="muted">No setups</span>';
  return assignedSetups.map(s=>`<span class="setup-tag" style="background:${s.color}" data-setup-id="${s.id}">${s.setup_name} ×</span>`).join('');
}

/* ---------------- ADD / REMOVE SETUP ---------------- */
async function addSetupToTrade(tradeId, setupId){
  const resp = await fetch("/api/trade_setup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ key_trade_id: tradeId, key_setup_id: setupId })
  });
  return resp.json();
}

async function removeSetupFromTrade(tradeSetupId){
  await fetch(`/api/trade_setup/${tradeSetupId}`, { method:"DELETE" });
}

/* ---------------- TOGGLE DETAILS ---------------- */
function toggleTradeDetails(tr, trade){
  if(openRow && openRow.tr === tr){
    closeDetails();
    return;
  }

  closeDetails();
  tr.classList.add("expanded");

  const strategyOptions = [
    `<option value="">No strategy</option>`,
    ...STRATEGIES.map(s=>`<option value="${s.id}" ${s.id===trade.key_strategies_id?"selected":""}>${s.strategy_name}</option>`)
  ].join("");

  const detailsTr = document.createElement("tr");
  detailsTr.className = "trade-details-row";
  const td = document.createElement("td");
  td.colSpan = COLUMN_ORDER.length;

  td.innerHTML = `
    <div class="trade-details">
      <div class="trade-details-grid">

        <div>
          <h4>Trade</h4>
          <div><strong>Symbol:</strong> ${trade.symbol}</div>
          <div><strong>Side:</strong> ${trade.side}</div>
          <div><strong>Qty:</strong> ${trade.qty}</div>
          <div><strong>Entry:</strong> ${formatDate(trade.entryTimestamp)}</div>
          <div><strong>Exit:</strong> ${formatDate(trade.exitTimestamp)}</div>
          <div><strong>PnL:</strong> ${formatPnL(trade.pnl)}</div>

          <div style="margin-top:10px;">
            <label><strong>Screenshot:</strong></label><br>
            <input type="file" class="trade-chart" accept="image/*">
            <div class="chart-preview" style="margin-top:5px;">
              ${trade.chart ? `<img src="${trade.chart}" style="max-width:100%; max-height:150px;">` : ""}
            </div>
          </div>
        </div>

        <div>
          <h4>Strategy</h4>
          <select class="trade-strategy" style="width:100%;">${strategyOptions}</select>
          <div class="strategy-tag-container" style="margin-top:6px;">
            ${renderStrategyTag(trade.key_strategies_id)}
          </div>

          <div style="margin-top:10px;">
            <label><strong>Notes:</strong></label><br>
            <textarea class="trade-notes" rows="4" style="width:100%;">${trade.notes??""}</textarea>
            <div class="notes-status muted" style="font-size:12px;"></div>
          </div>
        </div>

        <div>
          <h4>Setups</h4>
          <div class="setup-container" style="margin-top:6px;"></div>
          <select class="setup-add" style="margin-top:4px; width:100%;">
            <option value="">+ Add setup</option>
            ${SETUPS.map(s=>`<option value="${s.id}">${s.setup_name}</option>`).join('')}
          </select>
        </div>

      </div>
    </div>
  `;

  detailsTr.appendChild(td);
  tr.after(detailsTr);

  /* ---------- SMOOTH OPEN ---------- */
  const panel = td.querySelector(".trade-details");
  panel.offsetHeight;
  requestAnimationFrame(()=>panel.classList.add("open"));

  /* ---------- AUTOSAVE NOTES ---------- */
  const notesInput = td.querySelector(".trade-notes");
  const notesStatus = td.querySelector(".notes-status");
  let saveTimer = null;
  let abortController = null;
  notesInput.addEventListener("input", ()=>{
    notesStatus.textContent = "Saving…";
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      if(abortController) abortController.abort();
      abortController = new AbortController();
      try{
        await fetch(`/api/trades/${trade.id}`, {
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ notes: notesInput.value }),
          signal: abortController.signal
        });
        trade.notes = notesInput.value; // sync local state
        notesStatus.textContent = "Saved";
      }catch(err){
        if(err.name !== "AbortError") notesStatus.textContent = "Save failed";
      }
    },500);
  });

  /* ---------- STRATEGY AUTOSAVE ---------- */
  const strategySelect = td.querySelector(".trade-strategy");
  const strategyContainer = td.querySelector(".strategy-tag-container");
  strategySelect.addEventListener("change", ()=>{
    const val = strategySelect.value || null;
    fetch(`/api/trades/${trade.id}`,{
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ key_strategies_id: val })
    });
    trade.key_strategies_id = val ? Number(val) : null;
    strategyContainer.innerHTML = renderStrategyTag(trade.key_strategies_id);
  });

  /* ---------- SETUPS ---------- */
  const setupContainer = td.querySelector(".setup-container");
  const setupSelect = td.querySelector(".setup-add");

  // Fetch assigned setups
  fetch(`/api/trade_setup?trade_id=${trade.id}`)
    .then(r=>r.json())
    .then(assigned=>{
      setupContainer.innerHTML = renderSetupTags(assigned);

      // Attach remove handlers
      setupContainer.querySelectorAll(".setup-tag").forEach(tag=>{
        tag.addEventListener("click", async ()=>{
          const setupId = tag.dataset.setupId;
          const ts = assigned.find(a=>a.id==setupId);
          if(!ts) return;
          await removeSetupFromTrade(ts.id);
          tag.remove();
        });
      });

      // Add new setup
      setupSelect.addEventListener("change", async ()=>{
        const val = setupSelect.value;
        if(!val) return;
        const added = await addSetupToTrade(trade.id, val);
        const s = SETUPS.find(x=>x.id==val);
        const tag = document.createElement("span");
        tag.className = "setup-tag";
        tag.style.background = s.color;
        tag.dataset.setupId = added.id;
        tag.textContent = s.setup_name+" ×";
        setupContainer.appendChild(tag);

        tag.addEventListener("click", async ()=>{
          await removeSetupFromTrade(added.id);
          tag.remove();
        });

        setupSelect.value = "";
      });
    });

  /* ---------- SCREENSHOT UPLOAD ---------- */
  const chartInput = td.querySelector(".trade-chart");
  const chartPreview = td.querySelector(".chart-preview");
  chartInput.addEventListener("change", async e=>{
    const file = e.target.files[0];
    if(!file) return;
    const filename = `charts/${trade.id}_${Date.now()}_${file.name}`;
    try{
      const { error: uploadError } = await supabase.storage.from("charts").upload(filename, file);
      if(uploadError) throw uploadError;
      const { data: publicData, error: urlError } = await supabase.storage.from("charts").getPublicUrl(filename);
      if(urlError) throw urlError;
      const chartUrl = publicData.publicUrl;
      await fetch(`/api/trades/${trade.id}`,{
        method:"PATCH",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ chart: chartUrl })
      });
      chartPreview.innerHTML = `<img src="${chartUrl}" style="max-width:100%; max-height:150px;">`;
    }catch(err){
      alert("Failed to upload screenshot: "+err.message);
    }
  });

  openRow = { tr, detailsTr, panel };
}

/* ---------------- CLOSE DETAILS ---------------- */
function closeDetails(){
  if(!openRow) return;
  const { tr, detailsTr, panel } = openRow;
  tr.classList.remove("expanded");
  panel.classList.remove("open");
  setTimeout(()=>detailsTr.remove(), 250);
  openRow = null;
}

/* ---------------- FILTERS ---------------- */
function applyFiltersAndRender(){
  let data = [...originalData];

  const from = dateFrom.value ? new Date(dateFrom.value) : null;
  const to = dateTo.value ? new Date(dateTo.value) : null;
  if(from || to) data = data.filter(t=>{
    if(from && t.entryTimestamp<from) return false;
    if(to && t.entryTimestamp>to) return false;
    return true;
  });

  document.querySelectorAll("th input[data-col]").forEach(input=>{
    if(!input.value) return;
    const col = input.dataset.col;
    data = data.filter(r => String(r[col]??"").toLowerCase().includes(input.value.toLowerCase()));
  });

  data.sort((a,b)=>a.entryTimestamp-b.entryTimestamp);
  buildRows(data);
  updateCharts(data);
}

function resetFilters(){
  document.querySelectorAll("th input").forEach(i=>i.value="");
  dateFrom.value=""; dateTo.value="";
  buildRows(originalData);
  updateCharts(originalData);
}

/* ---------------- DELETE ---------------- */
function deleteSelected(){
  const ids = [...document.querySelectorAll(".row-select:checked")].map(cb=>Number(cb.dataset.id));
  if(!ids.length) return alert("No selection");
  fetch("/api/trades",{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ids})
  }).then(()=>{
    originalData = originalData.filter(t=>!ids.includes(t.id));
    applyFiltersAndRender();
  });
}

/* ---------------- CHART ---------------- */
function updateCharts(data){
  charts.pnl?.destroy();
  const daily = {};
  data.forEach(d=>{
    const day = `${d.entryTimestamp.getFullYear()}/${pad(d.entryTimestamp.getMonth()+1)}/${pad(d.entryTimestamp.getDate())}`;
    daily[day] = (daily[day]||0)+Number(d.pnl||0);
  });
  let cum=0, labels=[], values=[];
  Object.keys(daily).sort().forEach(d=>{
    cum+=daily[d];
    labels.push(d);
    values.push(cum);
  });
  charts.pnl = new Chart(pnlChart,{
    type:"line",
    data:{ labels, datasets:[{ data: values, borderColor:"green", backgroundColor:"rgba(0,255,0,0.2)", fill:true, tension:0.2 }] },
    options:{ maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });
}
</script>


{% endblock %}