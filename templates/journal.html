{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<h2>Trade Journal</h2>

<!-- Top controls -->
<div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <button onclick="applyDateFilter()">Apply Dates</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<!-- Layout -->
<div style="display: flex; gap: 20px; align-items: flex-start;">

  <!-- Table -->
  <div style="flex: 2;">
    <table id="tradeTable">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Charts -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 30px;">
    <canvas id="pnlChart" height="200"></canvas>
    <canvas id="winRateChart" height="200"></canvas>
    <canvas id="winRateSymbolChart" height="200"></canvas>
    <canvas id="biggestTradeChart" height="200"></canvas>
    <canvas id="drawdownChart" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let originalData = [];
let charts = {};

// Columns
const COLUMN_NAMES = {
  id: "ID",
  symbol: "Symbol",
  boughtTimestamp: "Bought",
  soldTimestamp: "Sold",
  duration: "Duration",
  side: "Side",
  qty: "Qty",
  buyPrice: "Buy Price",
  sellPrice: "Sell Price",
  pnl: "PnL"
};

const COLUMN_ORDER = [
  "id","symbol","boughtTimestamp","soldTimestamp",
  "duration","side","qty","buyPrice","sellPrice","pnl"
];

// Fetch data
fetch("/api/trades")
  .then(r => r.json())
  .then(data => {
    originalData = data.map(t => ({
      ...t,
      boughtTimestamp: new Date(t.boughtTimestamp),
      soldTimestamp: new Date(t.soldTimestamp)
    }));
    buildHeaders();
    applyFiltersAndRender();
  });

/* ---------- Formatting ---------- */
const pad = n => String(n).padStart(2, "0");

function formatDateTime(d) {
  if (!(d instanceof Date)) return "";
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function formatPnL(v) {
  const n = Number(v);
  if (isNaN(n)) return "";
  const f = Math.abs(n).toLocaleString("en-US", { minimumFractionDigits: 2 });
  return n < 0 ? `($${f})` : `$${f}`;
}

/* ---------- Table ---------- */
function buildHeaders() {
  const tr = document.getElementById("headerRow");
  tr.innerHTML = "";

  COLUMN_ORDER.forEach(col => {
    const th = document.createElement("th");
    th.textContent = COLUMN_NAMES[col];

    const input = document.createElement("input");
    input.placeholder = "Filter";
    input.onkeyup = applyFiltersAndRender;

    th.append(document.createElement("br"), input);
    tr.appendChild(th);
  });
}

function buildRows(data) {
  const tbody = document.querySelector("#tradeTable tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    // âœ… double-click opens TradingView
    tr.ondblclick = () => openTradeInTradingView(row);

    COLUMN_ORDER.forEach(col => {
      const td = document.createElement("td");

      if (col === "pnl") {
        td.textContent = formatPnL(row[col]);
        td.className = Number(row[col]) >= 0 ? "pnl-positive" : "pnl-negative";
      }
      else if (col === "boughtTimestamp" || col === "soldTimestamp") {
        td.textContent = formatDateTime(row[col]);
      }
      else {
        td.textContent = row[col] ?? "";
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ---------- Filters ---------- */
function applyDateFilter() {
  applyFiltersAndRender();
}

function applyFiltersAndRender() {
  const inputs = document.querySelectorAll("th input");
  const fromVal = dateFrom.value;
  const toVal = dateTo.value;

  let data = [...originalData];

  // Date range
  if (fromVal || toVal) {
    const from = fromVal ? new Date(fromVal) : null;
    const to = toVal ? new Date(toVal) : null;

    data = data.filter(t => {
      const d = t.boughtTimestamp;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    });
  }

  // Column filters
  inputs.forEach((i, idx) => {
    if (!i.value) return;
    const col = COLUMN_ORDER[idx];
    data = data.filter(r =>
      String(r[col] ?? "").toLowerCase().includes(i.value.toLowerCase())
    );
  });

  buildRows(data);
  updateCharts(data);
}

function resetFilters() {
  document.querySelectorAll("th input").forEach(i => i.value = "");
  dateFrom.value = "";
  dateTo.value = "";
  buildRows(originalData);
  updateCharts(originalData);
}

/* ---------- Charts ---------- */
const chartsConfig = [
  {
    id: "pnlChart",
    type: "line",
    dataFunc: data => {
      const daily = {};
      data.forEach(d => {
        const day =
          d.boughtTimestamp.getFullYear() + "/" +
          pad(d.boughtTimestamp.getMonth() + 1) + "/" +
          pad(d.boughtTimestamp.getDate());
        daily[day] = (daily[day] || 0) + (Number(d.pnl) || 0);
      });

      let cumulative = 0;
      const labels = [];
      const values = [];

      Object.keys(daily).sort().forEach(day => {
        cumulative += daily[day];
        labels.push(day);
        values.push(cumulative);
      });

      return {
        labels,
        datasets: [{
          label: "Cumulative PnL",
          data: values,
          borderColor: "green",
          backgroundColor: "rgba(0,255,0,0.2)",
          fill: true,
          tension: 0.2
        }]
      };
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  },

  {
    id: "winRateChart",
    type: "doughnut",
    dataFunc: data => {
      const w = data.filter(d => d.pnl > 0).length;
      const l = data.length - w;
      return {
        labels: ["Wins", "Losses"],
        datasets: [{ data: [w, l], backgroundColor: ["green", "red"] }]
      };
    }
  },

  {
    id: "winRateSymbolChart",
    type: "bar",
    dataFunc: data => {
      const s = {};
      data.forEach(d => {
        s[d.symbol] ??= { w: 0, t: 0 };
        if (d.pnl > 0) s[d.symbol].w++;
        s[d.symbol].t++;
      });
      return {
        labels: Object.keys(s),
        datasets: [{
          label: "Win %",
          data: Object.values(s).map(v => v.w / v.t * 100),
          backgroundColor: "blue"
        }]
      };
    },
    options: { scales: { y: { beginAtZero: true, max: 100 } } }
  },

  {
    id: "biggestTradeChart",
    type: "bar",
    dataFunc: data => ({
      labels: ["Biggest Win", "Biggest Loss"],
      datasets: [{
        data: [Math.max(...data.map(d => d.pnl)), Math.min(...data.map(d => d.pnl))],
        backgroundColor: ["green", "red"]
      }]
    })
  },

  {
    id: "drawdownChart",
    type: "bar",
    dataFunc: data => {
      let peak = 0, maxDD = 0;
      data.forEach(d => {
        peak = Math.max(peak, d.pnl);
        maxDD = Math.max(maxDD, peak - d.pnl);
      });
      return { labels: ["Max Drawdown"], datasets: [{ data: [maxDD], backgroundColor: "orange" }] };
    }
  }
];

function updateCharts(data) {
  chartsConfig.forEach(cfg => {
    charts[cfg.id]?.destroy();
    charts[cfg.id] = new Chart(
      document.getElementById(cfg.id),
      { type: cfg.type, data: cfg.dataFunc(data), options: cfg.options }
    );
  });
}

/* ---------- TradingView ---------- */
function toTradingViewSymbol(symbol) {
  const map = {
    MNQ: "CME:MNQ1!",
    NQ: "CME:NQ1!",
    ES: "CME:ES1!",
    MES: "CME_MINI:MES1!"
  };
  return map[symbol] || `CME:${symbol}`;
}

function openTradeInTradingView(trade, timeframe = 5) {
  const url =
    `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(toTradingViewSymbol(trade.symbol))}` +
    `&interval=${timeframe}` +
    `&timestamp=${trade.boughtTimestamp.getTime()}`;
  window.open(url, "_blank");
}
</script>

{% endblock %}
