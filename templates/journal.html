{% extends "base.html" %}

{% block title %}Journal{% endblock %}

{% block content %}

<h2>Trade Journal</h2>

<button id="resetSort" onclick="resetSort()">Reset sorting</button>

<table id="tradeTable">
  <thead>
    <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let originalData = [];
let currentSort = { column: null, direction: null };

// Fetch trades
fetch("/api/trades")
  .then(res => res.json())
  .then(data => {
    originalData = [...data];
    buildHeaders(Object.keys(data[0]));
    buildRows(data);
  });


function buildHeaders(columns) {
  const thead = document.getElementById("headerRow");
  thead.innerHTML = "";

  columns.forEach(col => {
    const th = document.createElement("th");

    const label = document.createElement("span");
    label.textContent = col;
    label.className = "sortable";
    label.onclick = () => sortTable(col, label);

    const input = document.createElement("input");
    input.placeholder = "Filter";
    input.onkeyup = filterTable;
    input.onclick = e => e.stopPropagation();
    input.onmousedown = e => e.stopPropagation();

    th.appendChild(label);
    th.appendChild(document.createElement("br"));
    th.appendChild(input);
    thead.appendChild(th);
  });
}

function buildRows(data) {
  const tbody = document.querySelector("#tradeTable tbody");
  tbody.innerHTML = "";

  const columns = Object.keys(data[0] || {});

  data.forEach(row => {
    const tr = document.createElement("tr");

    columns.forEach(col => {
      const td = document.createElement("td");
      td.textContent = row[col];

      if (col.toLowerCase() === "pnl") {
        td.className = Number(row[col]) >= 0
          ? "pnl-positive"
          : "pnl-negative";
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

  // Rows
  data.forEach(row => {
    const tr = document.createElement("tr");

    columns.forEach(col => {
      const td = document.createElement("td");
      td.textContent = row[col];

      // Conditional PnL coloring
      if (col.toLowerCase() === "pnl") {
        const val = Number(row[col]);
        td.className = val >= 0 ? "pnl-positive" : "pnl-negative";
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });


// Sorting
function sortTable(column, label) {
  const headers = document.querySelectorAll(".sortable");
  headers.forEach(h => h.classList.remove("active"));

  label.classList.add("active");

  const direction =
    currentSort.column === column && currentSort.direction === "asc"
      ? "desc"
      : "asc";

  currentSort = { column, direction };

  const sorted = [...originalData].sort((a, b) => {
    if (a[column] == null) return 1;
    if (b[column] == null) return -1;

    if (!isNaN(a[column])) {
      return direction === "asc"
        ? a[column] - b[column]
        : b[column] - a[column];
    }

    return direction === "asc"
      ? String(a[column]).localeCompare(String(b[column]))
      : String(b[column]).localeCompare(String(a[column]));
  });

  buildRows(sorted);
}

// Reset sorting
function resetSort() {
  currentSort = { column: null, direction: null };
  document.querySelectorAll(".sortable").forEach(h => h.classList.remove("active"));
  buildTable(originalData);
}

// Filtering
function filterTable() {
  const inputs = document.querySelectorAll("th input");
  let filtered = [...originalData];

  inputs.forEach((input, index) => {
    if (!input.value) return;

    filtered = filtered.filter(row =>
      String(Object.values(row)[index])
        .toLowerCase()
        .includes(input.value.toLowerCase())
    );
  });

  buildRows(filtered);
}
</script>

{% endblock %}
