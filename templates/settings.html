{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}

<h2>Settings</h2>

<div class="settings-container">

  <!-- PROFILE -->
  <div class="settings-block">
    <h3>Profile</h3>
    <p class="muted">Coming soon</p>
  </div>

  <!-- TRADING ACCOUNTS -->
  <div class="settings-block">
    <h3>Trading Accounts</h3>

    <table class="settings-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Broker</th>
          <th>Account #</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="accountsBody"></tbody>
    </table>

    <!-- ADD ACCOUNT -->
    <div class="account-add-row" onclick="addAccountRow()">
    + Add trading account
    </div>

  </div>

  <!-- JOURNAL -->
  <div class="settings-block">
    <h3>Journal</h3>
    <p class="muted">Coming soon</p>
  </div>

</div>

<script>
/* ================= LOAD ================= */
function loadAccounts() {
  fetch("/api/accounts")
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("accountsBody");
      tbody.innerHTML = "";

      data.forEach(acc => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <input value="${acc.name || ""}"
                   onchange="updateAccount('${acc.id}','name',this.value)">
          </td>
          <td>
            <input value="${acc.broker || ""}"
                   onchange="updateAccount('${acc.id}','broker',this.value)">
          </td>
          <td>
            <input value="${acc.account_number || ""}"
                   onchange="updateAccount('${acc.id}','account_number',this.value)">
          </td>
          <td>
            <button class="danger-btn"
                    onclick="deleteAccount('${acc.id}')">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    });
}

loadAccounts();

/* ================= ACCOUNT MANAGEMENT ================= */

<script>
/* ================= LOAD ================= */
function loadAccounts() {
  fetch("/api/accounts")
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("accountsBody");
      tbody.innerHTML = "";

      data.forEach(acc => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <input value="${acc.name || ""}"
                   onchange="updateAccount('${acc.id}','name',this.value)">
          </td>
          <td></td>
          <td></td>
          <td>
            <button class="danger-btn"
                    onclick="deleteAccount('${acc.id}')">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    });
}

loadAccounts();

/* ================= ADD ACCOUNT ================= */
function addAccountRow() {
  const tbody = document.getElementById("accountsBody");

  const tr = document.createElement("tr");
  tr.classList.add("new-account-row");

  tr.innerHTML = `
    <td><input placeholder="Account name"></td>
    <td></td>
    <td></td>
    <td></td>
  `;

  tbody.appendChild(tr);

  const input = tr.querySelector("input");
  input.focus();

  let saved = false;

  function cleanup() {
    if (!input.value.trim()) tr.remove();
  }

  function save() {
    if (saved) return;

    const name = input.value.trim();
    if (!name) return cleanup();

    saved = true;
    tr.style.opacity = "0.6";

    fetch("/api/accounts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    })
    .then(() => {
      tr.style.opacity = "1";
      loadAccounts();
    })
    .catch(() => tr.remove());
  }

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") save();
    if (e.key === "Escape") cleanup();
  });

  input.addEventListener("blur", save);
}

/* ================= UPDATE ================= */
function updateAccount(id, field, value) {
  fetch(`/api/accounts/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ [field]: value })
  });
}

/* ================= DELETE ================= */
function deleteAccount(id) {
  if (!confirm("Delete this account?")) return;

  fetch(`/api/accounts/${id}`, { method: "DELETE" })
    .then(loadAccounts);
}
</script>


{% endblock %}
