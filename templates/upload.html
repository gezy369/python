{% extends "base.html" %}

{% block title %}New Trades{% endblock %}

{% block content %}

<!-- ===== UPLOAD SECTION ===== -->
<div class="upload-container">

  <!-- LEFT: UPLOAD -->
  <div id="upload-left" class="tile">
    <h2>Upload CSV</h2>

    <div id="dropzone" class="dropzone">
      Drop CSV file here<br>or click to select
    </div>

    <input type="file" id="fileInput" accept=".csv" hidden>
    <button onclick="uploadFile()">Upload</button>

    <div id="message"></div>
  </div>

  <!-- RIGHT: EXPLANATION -->
  <div id=upload-right class="tile">
    <h2>How to upload file</h2>
    <p>
      <ul>
        <li>1. Open Tradovate (web) and go to "Reports" on the right Menu.</li>
        <li>2. Select the account you want to export from in the drop list on the left.</li>
        <li>3. Make sur you are in "Performance", select the dates and Download CSV.</li>
        <li>4. Uplaod your CSV file here.</li>
      </ul>
    </p>
    <p>The CSV will be processed and previewed underneath.<br>
    </p>
  </div>

</div>

<!-- ===== TABLE PREVIEW (OUTSIDE FLEX CONTAINER) ===== -->
<div id="table-container">
  <h2>Imported trades</h2>
</div>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const messageDiv = document.getElementById("message");
let selectedFile = null;

// --- Drag & Drop logic ---
dropzone.onclick = () => fileInput.click();

fileInput.onchange = (e) => {
  selectedFile = e.target.files[0];
  dropzone.innerHTML = "Selected: " + selectedFile.name;
};

dropzone.ondragover = (e) => {
  e.preventDefault();
  dropzone.classList.add("dragover");
};

dropzone.ondragleave = () => dropzone.classList.remove("dragover");

dropzone.ondrop = (e) => {
  e.preventDefault();
  dropzone.classList.remove("dragover");
  selectedFile = e.dataTransfer.files[0];
  dropzone.innerHTML = "Dropped: " + selectedFile.name;
};

// --- Upload ---
function uploadFile() {
  messageDiv.innerHTML = "";
  messageDiv.className = "";

  if (!selectedFile) {
    messageDiv.innerHTML = "No file selected";
    messageDiv.className = "error";
    return;
  }

  const formData = new FormData();
  formData.append("file", selectedFile);

  fetch("{{ url_for('upload_file') }}", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      messageDiv.innerHTML = data.error;
      messageDiv.className = "error";
    } else {
      messageDiv.innerHTML = "âœ… CSV processed";
      messageDiv.className = "success";

      renderTable(data.columns, data.rows);

      dropzone.innerHTML = "Drop another CSV file here";
      selectedFile = null;
    }
  })
  .catch(() => {
    messageDiv.innerHTML = "Upload failed";
    messageDiv.className = "error";
  });
}

// --- Table renderer (plain HTML) ---
function renderTable(columns, rows) {
  if (!rows || rows.length === 0) {
    document.getElementById("table-container").innerHTML =
      "<p>No data to display</p>";
    return;
  }

  let html = "<table>";
  html += "<thead><tr>";

  columns.forEach(col => {
    html += `<th>${col}</th>`;
  });

  html += "</tr></thead><tbody>";

  rows.forEach(row => {
    html += "<tr>";
    columns.forEach(col => {
      html += `<td>${row[col] ?? ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";

  document.getElementById("table-container").innerHTML = html;
}
</script>

{% endblock %}
