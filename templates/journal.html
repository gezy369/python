{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<h2>Trade Journal</h2>

<!-- ================= CONTROLS ================= -->
<div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <button onclick="applyFiltersAndRender()">Apply Dates</button>
  <button onclick="resetFilters()">Reset filters</button>

  <div style="width:20px;"></div>

  <select id="setupFilter" onchange="applyFiltersAndRender()">
    <option value="">All setups</option>
  </select>

  <button onclick="deleteSelected()" style="background:#c0392b;color:white;">
    Delete selected
  </button>
</div>

<div style="display:flex; gap:20px; align-items:flex-start;">
  <div style="flex:2;">
    <table id="tradeTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="flex:1; display:flex; flex-direction:column; gap:30px;">
    <div style="height:220px;"><canvas id="pnlChart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let originalData = [];
let charts = {};
let openRow = null;
let STRATEGIES = [];
let SETUPS = [];

/* ---------------- COLUMNS & FORMAT ---------------- */
const COLUMN_ORDER = ["select","symbol","entryTimestamp","exitTimestamp","duration","side","qty","entryPrice","exitPrice","pnl"];
const COLUMN_NAMES = { select:"", symbol:"Symbol", entryTimestamp:"Entry Time", exitTimestamp:"Exit Time", duration:"Duration", side:"Side", qty:"Qty", entryPrice:"Entry Price", exitPrice:"Exit Price", pnl:"PnL" };
const pad = n => String(n).padStart(2,"0");
const formatDate = d => `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const formatPnL = v => { const n = Number(v)||0; const f = Math.abs(n).toLocaleString("en-US",{minimumFractionDigits:2}); return n < 0 ? `($${f})` : `$${f}`; };

/* ---------------- FETCH DATA ---------------- */
Promise.all([
  fetch("/api/strategies").then(r => r.json()),
  fetch("/api/setups").then(r => r.json()),
  fetch("/api/trade_setups").then(r => r.json()),
  fetch("/api/trades").then(r => r.json())
]).then(([strategies, setups, tradeSetups, trades]) => {

  STRATEGIES = strategies;
  SETUPS = setups;

  const setupFilter = document.getElementById("setupFilter");
  if (setupFilter) {
    setupFilter.innerHTML = `<option value="">All setups</option>`;
    SETUPS.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.setup_name;
      setupFilter.appendChild(opt);
    });
  }

  originalData = trades.map(t => ({
    ...t,
    entryTimestamp: new Date(t.entryTimestamp),
    exitTimestamp: new Date(t.exitTimestamp),
    setups: tradeSetups
      .filter(ts => ts.key_trade_id === t.id)
      .map(ts => ts.key_setup_id)
  }));

  buildHeaders();
  applyFiltersAndRender();
});

/* ---------------- HEADERS ---------------- */
function buildHeaders(){
  const tr = document.getElementById("headerRow"); tr.innerHTML="";
  COLUMN_ORDER.forEach(col=>{
    const th = document.createElement("th");
    if(col==="select"){
      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.onclick=e=>{ document.querySelectorAll(".row-select").forEach(x=>x.checked=e.target.checked); };
      th.appendChild(cb);
    } else {
      th.textContent = COLUMN_NAMES[col] ?? col;
      const input=document.createElement("input");
      input.placeholder="Filter";
      input.dataset.col=col;
      input.onkeyup=applyFiltersAndRender;
      th.append(document.createElement("br"), input);
    }
    tr.appendChild(th);
  });
}

/* ---------------- RENDER ROWS ---------------- */
function buildRows(data){
  const tbody=document.querySelector("#tradeTable tbody");
  tbody.innerHTML="";
  data.forEach(row=>{
    const tr=document.createElement("tr");
    tr.className="trade-row";
    tr.onclick=()=>toggleTradeDetails(tr,row);

    COLUMN_ORDER.forEach(col=>{
      const td=document.createElement("td");
      if(col==="select"){
        const cb=document.createElement("input");
        cb.type="checkbox";
        cb.className="row-select";
        cb.dataset.id=row.id;
        cb.addEventListener("click",e=>e.stopPropagation());
        td.appendChild(cb);
      }
      else if(col==="pnl"){
        const v=Number(row[col])||0;
        td.textContent=formatPnL(v);
        td.className=v>=0?"pnl-positive":"pnl-negative";
      }
      else if(col.includes("Timestamp")) td.textContent=formatDate(row[col]);
      else td.textContent=row[col]??"";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ---------------- CHART ---------------- */
function renderPnLChart(data) {
  const ctx = document.getElementById("pnlChart");
  if (!ctx) return;

  if (charts.pnlChart) {
    charts.pnlChart.destroy();
  }

  let cumulative = 0;
  const pnlData = data.map(t => {
    cumulative += Number(t.pnl) || 0;
    return cumulative;
  });

  charts.pnlChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.map(t => formatDate(t.entryTimestamp)),
      datasets: [{
        label: "Cumulative PnL",
        data: pnlData,
        borderColor: "#2ecc71",     // ✅ green
        backgroundColor: "transparent",
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,            // ✅ instant updates
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: {
            callback: v => `$${v.toLocaleString()}`
          }
        }
      }
    }
  });
}


/* ---------------- FILTERS ---------------- */
function applyFiltersAndRender(){
  let data=[...originalData];

  const from=dateFrom.value?new Date(dateFrom.value):null;
  const to=dateTo.value?new Date(dateTo.value):null;
  if(from||to){
    data=data.filter(t=>{
      if(from&&t.entryTimestamp<from) return false;
      if(to&&t.entryTimestamp>to) return false;
      return true;
    });
  }

  document.querySelectorAll("th input[data-col]").forEach(input=>{
    if(!input.value) return;
    const col=input.dataset.col;
    data=data.filter(r=>String(r[col]??"").toLowerCase().includes(input.value.toLowerCase()));
  });

  const setupId = document.getElementById("setupFilter")?.value;
  if (setupId) {
    data = data.filter(t => t.setups?.includes(Number(setupId)));
  }

  data.sort((a,b)=>a.entryTimestamp-b.entryTimestamp);
  buildRows(data);
  renderPnLChart(data);
}
</script>

{% endblock %}
