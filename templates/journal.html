{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<h2>Trade Journal</h2>

<style>
/* ===== TABLE ===== */
#tradeTable {
  width: 100%;
  border-collapse: collapse;
}
#tradeTable th, #tradeTable td {
  padding: 6px 8px;
  border-bottom: 1px solid #ddd;
  font-size: 13px;
}

/* ===== ROW STATES ===== */
tr.trade-row {
  cursor: pointer;
  transition: background 0.15s ease;
}
tr.trade-row:hover {
  background: #f6f8fa;
}
tr.trade-row.expanded {
  background: #eef6ff;
}

/* ===== DETAILS ROW ===== */
tr.trade-details-row td {
  padding: 0;
  border: none;
}

.trade-details {
  overflow: hidden;
  max-height: 0;
  padding: 0 16px;
  background: #f9fbff;
  transition: max-height 0.25s ease, padding 0.25s ease;
}

.trade-details.open {
  max-height: 500px;
  padding: 16px;
}

/* ===== GRID ===== */
.trade-details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.trade-details h4 {
  margin: 0 0 8px;
  font-size: 13px;
  text-transform: uppercase;
  color: #666;
}

.trade-notes {
  width: 100%;
  resize: vertical;
}

.chart-preview img {
  max-width: 100%;
  max-height: 150px;
  border: 1px solid #ddd;
  margin-top: 6px;
}

.pnl-positive { color: green; }
.pnl-negative { color: red; }
</style>

<!-- ===== CONTROLS ===== -->
<div style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <button onclick="applyFiltersAndRender()">Apply Dates</button>
  <button onclick="resetFilters()">Reset</button>

  <div style="width:20px;"></div>

  <button onclick="deleteSelected()" style="background:#c0392b;color:white;">
    Delete selected
  </button>
</div>

<div style="display:flex; gap:20px;">
  <div style="flex:2;">
    <table id="tradeTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="flex:1;">
    <canvas id="pnlChart" height="220"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let originalData = [];
let openRow = null;
let charts = {};

/* ===== COLUMNS ===== */
const COLUMN_ORDER = [
  "select","symbol","entryTimestamp","exitTimestamp",
  "duration","side","qty","entryPrice","exitPrice","pnl"
];

const COLUMN_NAMES = {
  select:"",
  symbol:"Symbol",
  entryTimestamp:"Entry",
  exitTimestamp:"Exit",
  duration:"Duration",
  side:"Side",
  qty:"Qty",
  entryPrice:"Entry",
  exitPrice:"Exit",
  pnl:"PnL"
};

/* ===== HELPERS ===== */
const pad=n=>String(n).padStart(2,"0");
const formatDate=d=>`${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}
 ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const formatPnL=v=>{
  const n=Number(v)||0;
  const f=Math.abs(n).toLocaleString("en-US",{minimumFractionDigits:2});
  return n<0?`($${f})`:`$${f}`;
};

function debounce(fn, delay=600){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args),delay);
  };
}

/* ===== FETCH ===== */
fetch("/api/trades")
  .then(r=>r.json())
  .then(data=>{
    originalData=data.map(t=>({
      ...t,
      entryTimestamp:new Date(t.entryTimestamp),
      exitTimestamp:new Date(t.exitTimestamp)
    }));
    buildHeaders();
    applyFiltersAndRender();
  });

/* ===== HEADERS ===== */
function buildHeaders(){
  const tr=document.getElementById("headerRow");
  tr.innerHTML="";
  COLUMN_ORDER.forEach(col=>{
    const th=document.createElement("th");
    if(col==="select"){
      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.onclick=e=>{
        document.querySelectorAll(".row-select")
          .forEach(x=>x.checked=e.target.checked);
      };
      th.appendChild(cb);
    } else {
      th.textContent=COLUMN_NAMES[col];
      const i=document.createElement("input");
      i.placeholder="Filter";
      i.dataset.col=col;
      i.onkeyup=applyFiltersAndRender;
      th.append(document.createElement("br"),i);
    }
    tr.appendChild(th);
  });
}

/* ===== ROWS ===== */
function buildRows(data){
  const tbody=document.querySelector("#tradeTable tbody");
  tbody.innerHTML="";
  closeDetails();

  data.forEach(trade=>{
    const tr=document.createElement("tr");
    tr.className="trade-row";
    tr.onclick=()=>toggleTradeDetails(tr,trade);

    COLUMN_ORDER.forEach(col=>{
      const td=document.createElement("td");

      if(col==="select"){
        const cb=document.createElement("input");
        cb.type="checkbox";
        cb.className="row-select";
        cb.dataset.id=trade.id;
        cb.onclick=e=>e.stopPropagation();
        td.appendChild(cb);
      }
      else if(col==="pnl"){
        const v=Number(trade[col])||0;
        td.textContent=formatPnL(v);
        td.className=v>=0?"pnl-positive":"pnl-negative";
      }
      else if(col.includes("Timestamp")){
        td.textContent=formatDate(trade[col]);
      }
      else td.textContent=trade[col]??"";

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ===== DETAILS ===== */
function toggleTradeDetails(tr, trade){
  if(openRow && openRow.tr===tr){
    closeDetails();
    return;
  }

  closeDetails();
  tr.classList.add("expanded");

  const detailsTr=document.createElement("tr");
  detailsTr.className="trade-details-row";

  const td=document.createElement("td");
  td.colSpan=COLUMN_ORDER.length;

  td.innerHTML=`
    <div class="trade-details">
      <div class="trade-details-grid">
        <div>
          <h4>Trade</h4>
          <div><strong>Symbol:</strong> ${trade.symbol}</div>
          <div><strong>Side:</strong> ${trade.side}</div>
          <div><strong>Qty:</strong> ${trade.qty}</div>
          <div><strong>Entry:</strong> ${formatDate(trade.entryTimestamp)}</div>
          <div><strong>Exit:</strong> ${formatDate(trade.exitTimestamp)}</div>
          <div><strong>PnL:</strong> ${formatPnL(trade.pnl)}</div>

          <div style="margin-top:10px;">
            <strong>Notes</strong><br>
            <textarea class="trade-notes" rows="4">${trade.notes??""}</textarea>
          </div>

          <div style="margin-top:10px;">
            <strong>Screenshot</strong><br>
            <input type="file" class="trade-chart" accept="image/*">
            <div class="chart-preview">
              ${trade.chart?`<img src="${trade.chart}">`:""}
            </div>
          </div>
        </div>

        <div>
          <h4>Strategy</h4>
          <div class="muted">Coming soon</div>
        </div>
      </div>
    </div>
  `;

  detailsTr.appendChild(td);
  tr.after(detailsTr);

  const panel=td.querySelector(".trade-details");
  panel.offsetHeight;
  requestAnimationFrame(()=>panel.classList.add("open"));

  /* autosave notes */
  const notes=td.querySelector(".trade-notes");
  const saveNotes=debounce(v=>{
    fetch(`/api/trades/${trade.id}`,{
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({notes:v})
    });
  });

  notes.oninput=e=>saveNotes(e.target.value);

  /* upload screenshot */
  const fileInput=td.querySelector(".trade-chart");
  const preview=td.querySelector(".chart-preview");

  fileInput.onchange=()=>{
    const f=fileInput.files[0];
    if(!f) return;

    const fd=new FormData();
    fd.append("file",f);

    fetch(`/api/trades/${trade.id}/chart`,{method:"POST",body:fd})
      .then(r=>r.json())
      .then(d=>{
        preview.innerHTML=`<img src="${d.url}">`;
      });
  };

  openRow={tr,detailsTr,panel};
}

function closeDetails(){
  if(!openRow) return;
  openRow.panel.classList.remove("open");
  openRow.tr.classList.remove("expanded");
  setTimeout(()=>openRow.detailsTr.remove(),250);
  openRow=null;
}

/* ===== FILTERS ===== */
function applyFiltersAndRender(){
  let data=[...originalData];
  buildRows(data);
  updateChart(data);
}

function resetFilters(){
  document.querySelectorAll("th input").forEach(i=>i.value="");
  buildRows(originalData);
  updateChart(originalData);
}

/* ===== DELETE ===== */
function deleteSelected(){
  const ids=[...document.querySelectorAll(".row-select:checked")]
    .map(cb=>Number(cb.dataset.id));
  if(!ids.length) return;

  fetch("/api/trades",{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ids})
  }).then(()=>{
    originalData=originalData.filter(t=>!ids.includes(t.id));
    applyFiltersAndRender();
  });
}

/* ===== CHART ===== */
function updateChart(data){
  charts.pnl?.destroy();
  let cum=0,labels=[],values=[];
  data.forEach(d=>{
    cum+=Number(d.pnl||0);
    labels.push(formatDate(d.entryTimestamp).split(" ")[0]);
    values.push(cum);
  });
  charts.pnl=new Chart(pnlChart,{
    type:"line",
    data:{labels,datasets:[{data:values,fill:true}]},
    options:{plugins:{legend:{display:false}}}
  });
}
</script>

{% endblock %}
