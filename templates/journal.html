{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<h2>Trade Journal</h2>

<!-- ================= CONTROLS ================= -->
<div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <button onclick="applyDateFilter()">Apply Dates</button>
  <button onclick="resetFilters()">Reset filters</button>

  <div style="width:20px;"></div>

  <button onclick="deleteSelected()" style="background:#c0392b;color:white;">
    Delete selected
  </button>
</div>

<div style="display:flex; gap:20px; align-items:flex-start;">
  <div style="flex:2;">
    <table id="tradeTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="flex:1; display:flex; flex-direction:column; gap:30px;">
    <div style="height:220px;"><canvas id="pnlChart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let originalData = [];
let charts = {};
let openRow = null;

/* ---------------- COLUMNS ---------------- */
const COLUMN_ORDER = [
  "select","symbol","entryTimestamp","exitTimestamp",
  "duration","side","qty","entryPrice","exitPrice","pnl"
];

const COLUMN_NAMES = {
  select:"",
  symbol:"Symbol",
  entryTimestamp:"Entry",
  exitTimestamp:"Exit",
  duration:"Duration",
  side:"Side",
  qty:"Qty",
  entryPrice:"Entry",
  exitPrice:"Exit",
  pnl:"PnL"
};

/* ---------------- FETCH ---------------- */
fetch("/api/trades")
  .then(r=>r.json())
  .then(data=>{
    originalData = data.map(t=>({
      ...t,
      entryTimestamp:new Date(t.entryTimestamp),
      exitTimestamp:new Date(t.exitTimestamp)
    }));
    buildHeaders();
    applyFiltersAndRender();
  });

/* ---------------- FORMAT ---------------- */
const pad=n=>String(n).padStart(2,"0");
const formatDate=d=>`${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}
 ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const formatPnL=v=>{
  const n=Number(v)||0;
  const f=Math.abs(n).toLocaleString("en-US",{minimumFractionDigits:2});
  return n<0?`($${f})`:`$${f}`;
};

/* ---------------- HEADERS ---------------- */
function buildHeaders(){
  const tr=document.getElementById("headerRow");
  tr.innerHTML="";
  COLUMN_ORDER.forEach(col=>{
    const th=document.createElement("th");
    if(col==="select"){
      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.onclick=e=>{
        document.querySelectorAll(".row-select")
          .forEach(x=>x.checked=e.target.checked);
      };
      th.appendChild(cb);
    } else {
      th.textContent=COLUMN_NAMES[col];
      const input=document.createElement("input");
      input.placeholder="Filter";
      input.dataset.col=col;
      input.onkeyup=applyFiltersAndRender;
      th.append(document.createElement("br"),input);
    }
    tr.appendChild(th);
  });
}

/* ---------------- ROWS ---------------- */
function buildRows(data){
  const tbody=document.querySelector("#tradeTable tbody");
  tbody.innerHTML="";

  data.forEach(row=>{
    const tr=document.createElement("tr");
    tr.className="trade-row";
    tr.onclick=()=>toggleTradeDetails(tr,row);

    COLUMN_ORDER.forEach(col=>{
      const td=document.createElement("td");

      if(col==="select"){
        const cb=document.createElement("input");
        cb.type="checkbox";
        cb.className="row-select";
        cb.dataset.id=row.id;
        cb.addEventListener("click",e=>e.stopPropagation());
        td.appendChild(cb);
      }
      else if(col==="pnl"){
        const v=Number(row[col])||0;
        td.textContent=formatPnL(v);
        td.className=v>=0?"pnl-positive":"pnl-negative";
      }
      else if(col.includes("Timestamp")){
        td.textContent=formatDate(row[col]);
      }
      else{
        td.textContent=row[col]??"";
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ---------------- EXPAND / COLLAPSE ---------------- */
function toggleTradeDetails(tr, trade){
  if(openRow && openRow.tr === tr){
    closeDetails();
    return;
  }

  closeDetails();
  tr.classList.add("expanded");

  const detailsTr = document.createElement("tr");
  detailsTr.className = "trade-details-row";

  const td = document.createElement("td");
  td.colSpan = COLUMN_ORDER.length;

  td.innerHTML = `
  <div class="trade-details">
    <div class="trade-details-grid">
      <div>
        <h4>Trade</h4>
        <div><strong>Symbol:</strong> ${trade.symbol}</div>
        <div><strong>Side:</strong> ${trade.side}</div>
        <div><strong>Qty:</strong> ${trade.qty}</div>
        <div><strong>Entry:</strong> ${formatDate(trade.entryTimestamp)}</div>
        <div><strong>Exit:</strong> ${formatDate(trade.exitTimestamp)}</div>
        <div><strong>PnL:</strong> ${formatPnL(trade.pnl)}</div>

        <div style="margin-top:10px;">
          <label><strong>Notes:</strong></label><br>
          <textarea class="trade-notes" style="width:100%;" rows="4">${trade.notes ?? ""}</textarea>
        </div>

        <div style="margin-top:10px;">
          <label><strong>Screenshot:</strong></label><br>
          <input type="file" class="trade-chart" accept="image/*">
          <div class="chart-preview" style="margin-top:5px;">
            ${trade.chart ? `<img src="${trade.chart}" style="max-width:100%; max-height:150px;">` : ''}
          </div>
        </div>
      </div>

      <div>
        <h4>Strategy</h4>
        <div class="muted">No strategy data yet</div>
      </div>
    </div>
  </div>
`;

  detailsTr.appendChild(td);
  tr.after(detailsTr);

  const panel = td.querySelector(".trade-details");

  // ðŸ”‘ Force reflow so transition works
  panel.offsetHeight;

  // ðŸ”‘ Animate open on next frame
  requestAnimationFrame(() => panel.classList.add("open"));

  // ---------------- AUTOSAVE NOTES ----------------
  const notesInput = td.querySelector(".trade-notes");
  let saveTimeout;
  notesInput.addEventListener("input", () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      fetch(`/api/trades/${trade.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notes: notesInput.value })
      });
    }, 500); // debounce 0.5s
  });

  // ---------------- SCREENSHOT UPLOAD ----------------
  const chartInput = td.querySelector(".trade-chart");
  const chartPreview = td.querySelector(".chart-preview");

  chartInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const filename = `charts/${trade.id}_${Date.now()}_${file.name}`;

    try {
      // Upload to Supabase Storage (bucket: 'charts')
      const { data: uploadData, error } = await supabase.storage
        .from("charts")
        .upload(filename, file);

      if(error) throw error;

      // Get public URL
      const { data: publicData, error: urlError } = supabase.storage
        .from("charts")
        .getPublicUrl(filename);

      if(urlError) throw urlError;

      const chartUrl = publicData.publicUrl;

      // Update chart column in DB
      await fetch(`/api/trades/${trade.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chart: chartUrl })
      });

      // Show preview
      chartPreview.innerHTML = `<img src="${chartUrl}" style="max-width:100%; max-height:150px;">`;

    } catch(err) {
      alert("Failed to upload screenshot: " + err.message);
    }
  });

  openRow = { tr, detailsTr, panel };
}



function closeDetails(){
  if(!openRow) return;

  openRow.tr.classList.remove("expanded");
  openRow.panel.classList.remove("open");

  // Wait for animation to finish before removing row
  setTimeout(() => {
    openRow.detailsTr.remove();
    openRow = null;
  }, 250); // must match CSS transition duration
}


/* ---------------- FILTERS ---------------- */
function applyDateFilter(){ applyFiltersAndRender(); }

function applyFiltersAndRender(){
  let data=[...originalData];

  const from=dateFrom.value?new Date(dateFrom.value):null;
  const to=dateTo.value?new Date(dateTo.value):null;

  if(from||to){
    data=data.filter(t=>{
      if(from&&t.entryTimestamp<from) return false;
      if(to&&t.entryTimestamp>to) return false;
      return true;
    });
  }

  document.querySelectorAll("th input[data-col]").forEach(input=>{
    if(!input.value) return;
    const col=input.dataset.col;
    data=data.filter(r=>
      String(r[col]??"").toLowerCase()
        .includes(input.value.toLowerCase())
    );
  });

  data.sort((a,b)=>a.entryTimestamp-b.entryTimestamp);

  buildRows(data);
  updateCharts(data);
}

function resetFilters(){
  document.querySelectorAll("th input").forEach(i=>i.value="");
  dateFrom.value=""; dateTo.value="";
  buildRows(originalData);
  updateCharts(originalData);
}

/* ---------------- DELETE ---------------- */
function deleteSelected(){
  const ids=[...document.querySelectorAll(".row-select:checked")]
    .map(cb=>Number(cb.dataset.id));

  if(!ids.length) return alert("No selection");

  fetch("/api/trades",{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ids})
  }).then(()=>{
    originalData=originalData.filter(t=>!ids.includes(t.id));
    applyFiltersAndRender();
  });
}

/* ---------------- CHART ---------------- */
function updateCharts(data){
  charts.pnl?.destroy();

  const daily={};
  data.forEach(d=>{
    const day=`${d.entryTimestamp.getFullYear()}/${pad(d.entryTimestamp.getMonth()+1)}/${pad(d.entryTimestamp.getDate())}`;
    daily[day]=(daily[day]||0)+Number(d.pnl||0);
  });

  let cum=0, labels=[], values=[];
  Object.keys(daily).sort().forEach(d=>{
    cum+=daily[d];
    labels.push(d);
    values.push(cum);
  });

  charts.pnl=new Chart(pnlChart,{
    type:"line",
    data:{labels,datasets:[{
      data:values,
      borderColor:"green",
      backgroundColor:"rgba(0,255,0,0.2)",
      fill:true,
      tension:0.2
    }]},
    options:{maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
}
</script>

{% endblock %}